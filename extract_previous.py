from datetime import date, datetime
from sqlalchemy.orm import Session
from lotto_project.models.databasemanager import DrawResults, WinningCombinations, engine
from playwright.sync_api import sync_playwright
import decimal

def get_result_by_date(date_from: date, date_to: date):

    month_from = date_from.strftime("%B")
    year_from = date_from.strftime("%Y")
    day_from = date_from.strftime("%#d")

    month_to = date_to.strftime("%B")
    year_to = date_to.strftime("%Y")
    day_to = date_to.strftime("%#d")

    with sync_playwright() as p:
        
        browser = p.chromium.launch(headless=True)
        context = browser.new_context()
        page = context.new_page()
        
        page.goto("https://www.pcso.gov.ph/SearchLottoResult.aspx")
        
        page.wait_for_selector("id=cphContainer_cpContent_ddlStartMonth").select_option(value=month_from)
        page.wait_for_selector("id=cphContainer_cpContent_ddlStartDate").select_option(value=day_from)
        page.wait_for_selector("id=cphContainer_cpContent_ddlStartYear").select_option(value=year_from)

        page.wait_for_selector("id=cphContainer_cpContent_ddlEndMonth").select_option(value=month_to)
        page.wait_for_selector("id=cphContainer_cpContent_ddlEndDay").select_option(value=day_to)
        page.wait_for_selector("id=cphContainer_cpContent_ddlEndYear").select_option(value=year_to)

        page.get_by_role("button", name="Search Lotto").click()
        page.screenshot(path="screenshot.png")
        
        table = []
        table_rows = page.locator("table > tbody > tr")
        print(table_rows.count())

        for row_index in range(1,table_rows.count()):
            row = table_rows.nth(row_index)
            columns = row.locator("td")
            
            row_data = [columns.nth(col_index).text_content() for col_index in range(columns.count())]
            table.append(row_data)
            # print(table)
        page.wait_for_timeout(2000)
        browser.close() 

        return table

# result = get_result_by_date(date_from=date(2024, 3, 1),date_to= date(2024, 3, 3))    
 
# for r in result:
#     print(r)


def upload_to_db(table: list): 
    with Session(engine) as session:
        for sublist in table:
            game, combinations, draw_date, jackpot, winners = sublist
            formatted_combination = combinations.split('-')
              
            existing_result = session.query(DrawResults).filter(
                DrawResults.raw_lotto_game == game,
                DrawResults.raw_draw_date == datetime.strptime(draw_date, '%m/%d/%Y')
            ).first()

            if existing_result:
                print(f"Duplicate entry found for {game} on {draw_date}. Skipping insertion.")
                continue

            # Create a new DrawResults entry
            lotto_result = DrawResults(
                raw_lotto_game=game,
                raw_draw_date=datetime.strptime(draw_date, '%m/%d/%Y'),
                raw_jackpot=decimal.Decimal(jackpot.replace(',', '')),
                raw_winners=int(winners)
            )
            session.add(lotto_result)
            session.flush()  

            for number in formatted_combination:
                winning_result = WinningCombinations(
                    lotto_id=lotto_result.id,
                    draw_number=int(number.rstrip())
                )
                session.add(winning_result)

        session.commit()
    




# test_data =  [['Superlotto 6/49', '17-04-18-20-32-15', '2/29/2024', '24,744,968.20', '0'], ['Lotto 6/42', '05-21-03-33-30-41', '2/29/2024', '15,019,736.80', '1'], ['6D Lotto', '0-0-7-8-1-6      ', '2/29/2024', '6,312,426.24', '0'], ['3D Lotto 2PM', '3-8-2            ', '2/29/2024', '4,500.00', '375'], ['3D Lotto 5PM', '8-8-4            ', '2/29/2024', '4,500.00', '123'], ['3D Lotto 9PM', '4-8-7            ', '2/29/2024', '4,500.00', '515'], ['2D Lotto 2PM', '12-10            ', '2/29/2024', '4,000.00', '230'], ['2D Lotto 5PM', '08-18            ', '2/29/2024', '4,000.00', '528'], ['2D Lotto 9PM', '24-29            ', '2/29/2024', '4,000.00', '400'], ['Grand Lotto 6/55', '49-37-51-36-50-10', '2/28/2024', '88,249,297.40', '0'], ['Megalotto 6/45', '41-35-18-43-33-40', '2/28/2024', '8,910,000.00', '0'], ['4D Lotto', '7-3-2-5          ', '2/28/2024', '13,421.00', '35'], ['3D Lotto 2PM', '7-3-5            ', '2/28/2024', '4,500.00', '204'], ['3D Lotto 5PM', '2-2-7            ', '2/28/2024', '4,500.00', '562'], ['3D Lotto 9PM', '8-6-5            ', '2/28/2024', '4,500.00', '331'], ['2D Lotto 2PM', '26-12            ', '2/28/2024', '4,000.00', '549'], ['2D Lotto 5PM', '18-03            ', '2/28/2024', '4,000.00', '198'], ['2D Lotto 9PM', '30-09            ', '2/28/2024', '4,000.00', '327'], ['Ultra Lotto 6/58', '09-14-37-22-13-20', '2/27/2024', '166,577,603.60', '0'], ['Superlotto 6/49', '19-03-48-31-10-43', '2/27/2024', '20,070,091.60', '0'], ['Lotto 6/42', '41-26-32-40-31-39', '2/27/2024', '10,877,076.20', '0'], ['6D Lotto', '4-0-5-2-9-7      ', '2/27/2024', '5,570,425.80', '0'], ['3D Lotto 2PM', '0-9-7            ', '2/27/2024', '4,500.00', '108'], ['3D Lotto 5PM', '2-9-1            ', '2/27/2024', '4,500.00', '99'], ['3D Lotto 9PM', '3-6-0            ', '2/27/2024', '4,500.00', '602'], ['2D Lotto 2PM', '12-08            ', '2/27/2024', '4,000.00', '406'], ['2D Lotto 5PM', '04-21            ', '2/27/2024', '4,000.00', '275'], ['2D Lotto 9PM', '26-13            ', '2/27/2024', '4,000.00', '236'], ['Grand Lotto 6/55', '22-18-35-39-48-08', '2/26/2024', '82,609,283.80', '0'], ['Megalotto 6/45', '29-07-09-20-03-26', '2/26/2024', '70,879,526.00', '2'], ['4D Lotto', '0-7-1-2          ', '2/26/2024', '10,000.00', '75'], ['3D Lotto 2PM', '0-1-9            ', '2/26/2024', '4,500.00', '495'], ['3D Lotto 5PM', '6-2-5            ', '2/26/2024', '4,500.00', '176'], ['3D Lotto 9PM', '8-9-4            ', '2/26/2024', '4,500.00', '209'], ['2D Lotto 2PM', '25-20            ', '2/26/2024', '4,000.00', '83'], ['2D Lotto 5PM', '03-22            ', '2/26/2024', '4,000.00', '222'], ['2D Lotto 9PM', '13-05            ', '2/26/2024', '4,000.00', '471'], ['Ultra Lotto 6/58', '06-33-48-56-27-35', '2/25/2024', '159,479,545.60', '0'], ['Superlotto 6/49', '20-49-43-46-44-08', '2/25/2024', '16,625,593.40', '0'], ['3D Lotto 2PM', '7-7-7            ', '2/25/2024', '4,500.00', '609'], ['3D Lotto 5PM', '6-8-3            ', '2/25/2024', '4,500.00', '93'], ['3D Lotto 9PM', '6-0-9            ', '2/25/2024', '4,500.00', '499'], ['2D Lotto 2PM', '09-09            ', '2/25/2024', '4,000.00', '970'], ['2D Lotto 5PM', '08-03            ', '2/25/2024', '4,000.00', '231'], ['2D Lotto 9PM', '12-14            ', '2/25/2024', '4,000.00', '467'], ['Grand Lotto 6/55', '42-44-01-24-47-02', '2/24/2024', '77,742,342.40', '0'], ['Lotto 6/42', '32-12-27-40-01-19', '2/24/2024', '7,433,279.40', '0'], ['6D Lotto', '1-7-4-3-8-5      ', '2/24/2024', '4,778,396.84', '0'], ['3D Lotto 2PM', '2-6-7            ', '2/24/2024', '4,500.00', '206'], ['3D Lotto 5PM', '0-4-5            ', '2/24/2024', '4,500.00', '163'], ['3D Lotto 9PM', '3-4-3            ', '2/24/2024', '4,500.00', '292'], ['2D Lotto 2PM', '31-05            ', '2/24/2024', '4,000.00', '165'], ['2D Lotto 5PM', '04-24            ', '2/24/2024', '4,000.00', '448'], ['2D Lotto 9PM', '12-06            ', '2/24/2024', '4,000.00', '446'], ['Ultra Lotto 6/58', '29-55-36-58-10-50', '2/23/2024', '151,920,834.00', '0'], ['Megalotto 6/45', '33-27-29-26-45-04', '2/23/2024', '64,871,617.60', '0'], ['4D Lotto', '0-1-6-2          ', '2/23/2024', '139,582.00', '7'], ['3D Lotto 2PM', '9-1-2            ', '2/23/2024', '4,500.00', '367'], ['3D Lotto 5PM', '1-1-9            ', '2/23/2024', '4,500.00', '607'], ['3D Lotto 9PM', '3-5-7            ', '2/23/2024', '4,500.00', '628'], ['2D Lotto 2PM', '21-02            ', '2/23/2024', '4,000.00', '105'], ['2D Lotto 5PM', '08-05            ', '2/23/2024', '4,000.00', '275'], ['2D Lotto 9PM', '01-20            ', '2/23/2024', '4,000.00', '599'], ['Superlotto 6/49', '36-11-06-46-16-17', '2/22/2024', '15,840,000.00', '0'], ['Lotto 6/42', '05-21-17-36-22-07', '2/22/2024', '5,940,000.00', '0'], ['6D Lotto', '3-5-9-8-5-1      ', '2/22/2024', '3,991,579.08', '0'], ['3D Lotto 2PM', '3-2-2            ', '2/22/2024', '4,500.00', '252'], ['3D Lotto 5PM', '6-2-7            ', '2/22/2024', '4,500.00', '245'], ['3D Lotto 9PM', '9-7-3            ', '2/22/2024', '4,500.00', '245'], ['2D Lotto 2PM', '07-18            ', '2/22/2024', '4,000.00', '325'], ['2D Lotto 5PM', '15-24            ', '2/22/2024', '4,000.00', '173'], ['2D Lotto 9PM', '04-14            ', '2/22/2024', '4,000.00', '974'], ['Grand Lotto 6/55', '15-08-02-49-50-45', '2/21/2024', '72,157,497.80', '0'], ['Megalotto 6/45', '04-06-05-12-28-22', '2/21/2024', '59,088,473.80', '0'], ['4D Lotto', '2-0-7-6          ', '2/21/2024', '39,422.00', '26'], ['3D Lotto 2PM', '3-2-2            ', '2/21/2024', '4,500.00', '395'], ['3D Lotto 5PM', '7-1-3            ', '2/21/2024', '4,500.00', '169'], ['3D Lotto 9PM', '9-4-9            ', '2/21/2024', '4,500.00', '285'], ['2D Lotto 2PM', '02-10            ', '2/21/2024', '4,000.00', '816'], ['2D Lotto 5PM', '05-06            ', '2/21/2024', '4,000.00', '272'], ['2D Lotto 9PM', '11-04            ', '2/21/2024', '4,000.00', '703'], ['Ultra Lotto 6/58', '43-08-32-01-10-42', '2/20/2024', '144,244,941.60', '0'], ['Superlotto 6/49', '23-02-05-40-26-33', '2/20/2024', '15,840,000.00', '0'], ['Lotto 6/42', '22-17-01-29-11-16', '2/20/2024', '10,990,641.60', '1'], ['6D Lotto', '7-2-5-8-8-5      ', '2/20/2024', '3,104,678.72', '0'], ['3D Lotto 2PM', '7-2-9            ', '2/20/2024', '4,500.00', '637'], ['3D Lotto 5PM', '8-2-9            ', '2/20/2024', '4,500.00', '307'], ['3D Lotto 9PM', '5-1-5            ', '2/20/2024', '4,500.00', '620'], ['2D Lotto 2PM', '20-22            ', '2/20/2024', '4,000.00', '296'], ['2D Lotto 5PM', '11-14            ', '2/20/2024', '4,000.00', '267'], ['2D Lotto 9PM', '30-16            ', '2/20/2024', '4,000.00', '117'], ['Grand Lotto 6/55', '27-55-48-54-31-03', '2/19/2024', '67,274,931.60', '0'], ['Megalotto 6/45', '18-36-11-19-05-04', '2/19/2024', '53,341,620.40', '0'], ['4D Lotto', '3-4-6-0          ', '2/19/2024', '61,397.00', '15'], ['3D Lotto 2PM', '3-8-9            ', '2/19/2024', '4,500.00', '199'], ['3D Lotto 5PM', '4-9-4            ', '2/19/2024', '4,500.00', '141'], ['3D Lotto 9PM', '2-5-6            ', '2/19/2024', '4,500.00', '602'], ['2D Lotto 2PM', '28-15            ', '2/19/2024', '4,000.00', '93'], ['2D Lotto 5PM', '05-15            ', '2/19/2024', '4,000.00', '266'], ['2D Lotto 9PM', '03-01            ', '2/19/2024', '4,000.00', '634'], ['Ultra Lotto 6/58', '55-01-20-03-58-10', '2/18/2024', '137,271,570.80', '0'], ['Superlotto 6/49', '19-28-09-49-48-25', '2/18/2024', '15,840,000.00', '0'], ['3D Lotto 2PM', '5-8-2            ', '2/18/2024', '4,500.00', '235'], ['3D Lotto 5PM', '1-0-3            ', '2/18/2024', '4,500.00', '262'], ['3D Lotto 9PM', '2-4-5            ', '2/18/2024', '4,500.00', '610'], ['2D Lotto 2PM', '26-22            ', '2/18/2024', '4,000.00', '130'], ['2D Lotto 5PM', '31-06            ', '2/18/2024', '4,000.00', '53'], ['2D Lotto 9PM', '25-08            ', '2/18/2024', '4,000.00', '369'], ['Grand Lotto 6/55', '07-46-14-54-30-44', '2/17/2024', '62,425,096.00', '0'], ['Lotto 6/42', '29-14-13-05-09-18', '2/17/2024', '7,488,195.20', '0'], ['6D Lotto', '2-0-6-5-5-4      ', '2/17/2024', '2,602,804.84', '0'], ['3D Lotto 2PM', '4-9-6            ', '2/17/2024', '4,500.00', '121'], ['3D Lotto 5PM', '6-1-8            ', '2/17/2024', '4,500.00', '359'], ['3D Lotto 9PM', '1-7-8            ', '2/17/2024', '4,500.00', '602'], ['2D Lotto 2PM', '03-03            ', '2/17/2024', '4,000.00', '947'], ['2D Lotto 5PM', '07-05            ', '2/17/2024', '4,000.00', '351'], ['2D Lotto 9PM', '22-03            ', '2/17/2024', '4,000.00', '330'], ['Ultra Lotto 6/58', '29-03-07-11-17-58', '2/16/2024', '129,732,562.40', '0'], ['Megalotto 6/45', '14-42-03-31-41-11', '2/16/2024', '47,590,816.20', '0'], ['4D Lotto', '4-9-2-4          ', '2/16/2024', '16,810.00', '24'], ['3D Lotto 2PM', '5-5-5            ', '2/16/2024', '4,500.00', '646'], ['3D Lotto 5PM', '4-6-8            ', '2/16/2024', '4,500.00', '305'], ['3D Lotto 9PM', '8-7-0            ', '2/16/2024', '4,500.00', '273'], ['2D Lotto 2PM', '19-12            ', '2/16/2024', '4,000.00', '190'], ['2D Lotto 5PM', '06-14            ', '2/16/2024', '4,000.00', '150'], ['2D Lotto 9PM', '20-11            ', '2/16/2024', '4,000.00', '319'], ['Superlotto 6/49', '19-10-08-24-20-13', '2/15/2024', '64,105,266.60', '1'], ['Lotto 6/42', '09-38-28-22-04-20', '2/15/2024', '5,940,000.00', '0'], ['6D Lotto', '3-7-5-0-2-5      ', '2/15/2024', '2,023,034.64', '0']]
# # test_data1 = [['55', '52', '53', '58', '45', '42'], ['13', '20', '06', '37', '40', '39'], ['03', '24', '40', '18', '35', '41'], ['3', '7', '7', '5', '0', '1      '], ['9', '0', '2            '], ['8', '6', '6            '], ['6', '7', '1            '], ['01', '14            '], ['14', '19            '], ['15', '27            '], ['07', '31', '49', '33', '32', '40'], ['23', '28', '24', '40', '35', '44'], ['3', '1', '4', '6          '], ['8', '3', '4            '], ['8', '3', '9            '], ['4', '0', '5            '], ['23', '19            '], ['01', '23            '], ['14', '07            '], ['56', '57', '24', '09', '30', '31'], ['02', '40', '03', '36', '49', '14'], ['0', '8', '2            '], ['5', '9', '3            '], ['9', '6', '8            '], ['29', '24            '], ['07', '05            '], ['01', '07            '], ['32', '25', '16', '36', '33', '29'], ['17', '02', '04', '03', '36', '35'], ['8', '9', '4', '9', '9', '7      '], ['2', '3', '3            '], ['2', '1', '4            '], ['5', '8', '8            '], ['10', '26            '], ['18', '29            '], ['09', '12            '], ['04', '07', '57', '05', '54', '47'], ['15', '08', '17', '24', '31', '12'], ['3', '1', '7', '5          '], ['2', '8', '3            '], ['4', '4', '5            '], ['8', '7', '0            '], ['31', '24            '], ['25', '26            '], ['21', '20            ']]
table = get_result_by_date(date(2024, 3, 1), date(2024, 3, 31))
upload_to_db(table=table)   
# print(table)
 